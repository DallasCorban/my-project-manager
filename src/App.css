import React, { useState, useEffect, useRef, useMemo, useLayoutEffect, useCallback } from 'react';
import { 
  Mic, Send, BarChart2, FileText, Plus, ChevronRight, ChevronDown, ChevronLeft, Zap, Layout,
  MessageSquare, GripVertical, ZoomIn, ZoomOut, ArrowUpDown, ChevronsDown, ChevronsUp,
  MoreHorizontal, X, Edit2, Check, Briefcase, LayoutDashboard, Settings, Square, CheckSquare,
  Moon, Sun, CornerDownRight, Trash2, Palette, GripHorizontal, Pipette, CheckCircle2,
  Calendar as CalendarIcon, CalendarOff, Layers, Tag, Eye, Target, Download, Upload
} from 'lucide-react';

// ==========================================
// 1. CONSTANTS & CONFIGURATION
// ==========================================

const DEFAULT_STATUSES = [
  { id: 'done', label: 'Done', color: '#00c875' },
  { id: 'working', label: 'Working on it', color: '#fdab3d' },
  { id: 'stuck', label: 'Stuck', color: '#e2445c' },
  { id: 'pending', label: 'Pending', color: '#c4c4c4' },
  { id: 'review', label: 'In Review', color: '#a25ddc' } 
];

const DEFAULT_JOB_TYPES = [
  { id: 'design', label: 'Design', color: '#ff007f' },
  { id: 'dev', label: 'Development', color: '#0086c0' },
  { id: 'marketing', label: 'Marketing', color: '#9cd326' },
  { id: 'planning', label: 'Planning', color: '#a25ddc' },
  { id: 'research', label: 'Research', color: '#ffcb00' }
];

const MONDAY_PALETTE = [
  "#00c875", "#9cd326", "#cab641", "#ffcb00", "#fdab3d", "#ff642e", "#e2445c", "#ff007f",
  "#ff5ac4", "#ffcead", "#a25ddc", "#784bd1", "#579bfc", "#0086c0", "#595ad4", "#037f4c",
  "#00ca72", "#3b85f6", "#175a63", "#333333", "#7f5f3f", "#dff0ff", "#304575", "#7f8c8d",
  "#c4c4c4", "#808080", "#111111", "#b5c0d0"
];

const PAST_DAYS = 60;
const FUTURE_DAYS = 365;
const TIMELINE_TOTAL_DAYS = PAST_DAYS + FUTURE_DAYS;
const TODAY = new Date(); 

// --- INITIAL DATA ---
const INITIAL_WORKSPACES = [
  { id: 'w1', name: 'Main Workspace', type: 'workspace' },
  { id: 'w2', name: 'Marketing', type: 'workspace' }
];

const INITIAL_DASHBOARDS = [
  { id: 'd1', name: 'Overview', type: 'dashboard', includedWorkspaces: ['w1'] }
];

const INITIAL_PROJECTS = [
  {
    id: 'p1', workspaceId: 'w1', name: 'Website Redesign', status: 'working',
    groups: [
      { id: 'g1', name: 'Phase 1: Planning', color: '#579bfc' }, 
      { id: 'g2', name: 'Phase 2: Development', color: '#a25ddc' }
    ],
    tasks: [
      { 
        id: 't1', groupId: 'g1', name: 'Discovery Phase', start: 0, duration: 15, progress: 100, status: 'done', assignee: 'Sarah', priority: 'High', jobTypeId: 'research',
        subitems: [
           { id: 's1', name: 'Stakeholder Interviews', status: 'done', assignee: 'Sarah', start: 0, duration: 5, jobTypeId: 'research' },
           { id: 's2', name: 'Requirement Gathering', status: 'working', assignee: 'Mike', start: 5, duration: 10, jobTypeId: 'planning' }
        ]
      },
      { id: 't2', groupId: 'g1', name: 'Wireframing', start: 16, duration: 20, progress: 60, status: 'working', assignee: 'Mike', priority: 'Medium', jobTypeId: 'design', subitems: [] },
      { id: 't3', groupId: 'g2', name: 'UI Design', start: 30, duration: 30, progress: 0, status: 'pending', assignee: 'Jessica', priority: 'High', jobTypeId: 'design', subitems: [] },
      { id: 't4', groupId: 'g2', name: 'Frontend Dev', start: null, duration: null, progress: 0, status: 'pending', assignee: 'Dev Team', priority: 'High', jobTypeId: 'dev', subitems: [] },
    ]
  },
  {
    id: 'p2', workspaceId: 'w1', name: 'Mobile App', status: 'stuck',
    groups: [{ id: 'g4', name: 'Milestones', color: '#00c875' }],
    tasks: [{ id: 't5', groupId: 'g4', name: 'Market Research', start: 5, duration: 14, progress: 100, status: 'done', assignee: 'Marketing', priority: 'Medium', jobTypeId: 'marketing', subitems: [] }]
  }
];

// ==========================================
// 2. HELPER FUNCTIONS & HOOKS
// ==========================================

const getDateFromRelative = (days) => {
  if (days === null || days === undefined) return null;
  const date = new Date(TODAY);
  date.setDate(TODAY.getDate() + days);
  return date;
};

const getRelativeFromDate = (date) => {
  const diffTime = date - TODAY;
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
};

const getFutureDate = (daysToAdd) => {
  if (daysToAdd === null || daysToAdd === undefined) return null;
  const date = new Date(TODAY);
  date.setDate(TODAY.getDate() + daysToAdd);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
};

const generateTimelineData = () => {
  const days = [];
  const start = new Date(TODAY);
  start.setDate(TODAY.getDate() - PAST_DAYS);

  for (let i = 0; i < TIMELINE_TOTAL_DAYS; i++) {
    const date = new Date(start);
    date.setDate(start.getDate() + i);
    const relativeIndex = i - PAST_DAYS;
    const dayNum = date.getDate();
    const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    const dayOfWeek = date.getDay();
    const isMonday = dayOfWeek === 1;
    let weekLabel = "";
    if (isMonday) {
        const friday = new Date(date);
        friday.setDate(date.getDate() + 4);
        weekLabel = `${date.getDate()} - ${friday.getDate()}`;
    }
    days.push({ 
        index: relativeIndex, dayNum, dayName: date.toLocaleDateString('en-US', { weekday: 'short' }), 
        monthName, isWeekend: dayOfWeek === 0 || dayOfWeek === 6, isMonday, isToday: relativeIndex === 0, weekLabel 
    });
  }
  return days;
};

const calculateCalendarDuration = (startDateIndex, visualSpan, rawDays, showWeekends) => {
    let currentRelIndex = startDateIndex;
    let visibleDaysCounted = 0;
    let loopSafety = 0;
    while (visibleDaysCounted < visualSpan && loopSafety < 3650) {
         loopSafety++;
         const arrayIndex = currentRelIndex + PAST_DAYS;
         if (arrayIndex < 0 || arrayIndex >= rawDays.length) break; 
         const day = rawDays[arrayIndex];
         if (day) {
             if (showWeekends || !day.isWeekend) visibleDaysCounted++;
         }
         currentRelIndex++;
    }
    return Math.max(1, currentRelIndex - startDateIndex);
};

// --- CUSTOM HOOK: PERSISTENT STATE ---
function usePersistentState(key, initialValue) {
  const [state, setState] = useState(() => {
    try {
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : initialValue;
    } catch (error) {
      console.warn(`Error reading localStorage key "${key}":`, error);
      return initialValue;
    }
  });

  useEffect(() => {
    try {
      window.localStorage.setItem(key, JSON.stringify(state));
    } catch (error) {
      console.warn(`Error saving localStorage key "${key}":`, error);
    }
  }, [key, state]);

  return [state, setState];
}

// --- CUSTOM HOOK: PROJECT DATA LOGIC ---
function useProjectData() {
  const [projects, setProjects] = usePersistentState('pmai_projects', INITIAL_PROJECTS);

  // Helper to update specific fields cleanly
  const updateTaskField = (pid, tid, sid, field, value, isSubitem) => { 
    setProjects(prev => prev.map(p => { 
        if (p.id !== pid) return p; 
        return { 
            ...p, 
            tasks: p.tasks.map(t => { 
                if (isSubitem) { 
                    if (t.subitems.some(sub => sub.id === tid)) { 
                        return { ...t, subitems: t.subitems.map(sub => sub.id === tid ? { ...sub, [field]: value } : sub) }; 
                    } 
                    return t; 
                } 
                return t.id === tid ? { ...t, [field]: value } : t; 
            }) 
        }; 
    })); 
  };

  const actions = {
    addGroup: (projectId) => { const newGroup = { id: `g${Date.now()}`, name: 'New Group', color: '#579bfc' }; setProjects(prev => prev.map(p => p.id === projectId ? { ...p, groups: [...p.groups, newGroup] } : p)); },
    updateProjectName: (id, v) => setProjects(prev => prev.map(p => p.id === id ? { ...p, name: v } : p)),
    updateGroupName: (pid, gid, v) => setProjects(prev => prev.map(p => p.id === pid ? { ...p, groups: p.groups.map(g => g.id === gid ? { ...g, name: v } : g) } : p)),
    updateTaskName: (pid, tid, v) => setProjects(prev => prev.map(p => p.id === pid ? { ...p, tasks: p.tasks.map(t => t.id === tid ? { ...t, name: v } : t) } : p)),
    updateSubitemName: (pid, tid, sid, v) => setProjects(prev => prev.map(p => p.id === pid ? { ...p, tasks: p.tasks.map(t => t.id === tid ? { ...t, subitems: t.subitems.map(s => s.id === sid ? { ...s, name: v } : s) } : t) } : p)),
    addTaskToGroup: (pid, gid, name) => { const newTask = { id: `t${Date.now()}`, groupId: gid, name: name || 'New Item', start: null, duration: null, progress: 0, status: 'pending', jobTypeId: 'dev', assignee: 'Unassigned', priority: 'Low', subitems: [] }; setProjects(prev => prev.map(p => p.id === pid ? { ...p, tasks: [...p.tasks, newTask] } : p)); },
    addSubitem: (pid, tid, name) => { const newSub = { id: `s${Date.now()}`, name: name || 'New Subitem', status: 'pending', jobTypeId: 'dev', assignee: 'Unassigned', start: null, duration: null }; setProjects(prev => prev.map(p => p.id === pid ? { ...p, tasks: p.tasks.map(t => t.id === tid ? { ...t, subitems: [...t.subitems, newSub] } : t) } : p)); },
    updateTaskDate: (pid, tid, sid, start, duration) => { setProjects(prev => prev.map(p => { if (p.id !== pid) return p; return { ...p, tasks: p.tasks.map(t => { if (sid) { if (t.id === tid) { return { ...t, subitems: t.subitems.map(sub => { if (sub.id === sid) { return { ...sub, start, duration }; } return sub; }) }; } return t; } if (t.id === tid) { return { ...t, start, duration }; } return t; }) }; })); },
    changeStatus: (pid, tid, sid, val) => { if (sid) updateTaskField(pid, sid, null, 'status', val, true); else updateTaskField(pid, tid, null, 'status', val, false); },
    changeJobType: (pid, tid, sid, val) => { if (sid) updateTaskField(pid, sid, null, 'jobTypeId', val, true); else updateTaskField(pid, tid, null, 'jobTypeId', val, false); },
    deleteSelection: (selectedIds) => { setProjects(prev => prev.map(p => ({ ...p, tasks: p.tasks.filter(t => !selectedIds.has(t.id)).map(t => ({ ...t, subitems: t.subitems.filter(s => !selectedIds.has(s.id)) })) }))); }
  };

  return { projects, setProjects, ...actions };
}

// ==========================================
// 3. SHARED ATOMIC COMPONENTS
// ==========================================

const EditableText = ({ value, onChange, className, style, placeholder, autoFocus, onBlur }) => {
  const spanRef = useRef(null);
  const [width, setWidth] = useState('auto');
  useLayoutEffect(() => {
    if (spanRef.current) setWidth(`${Math.max(20, spanRef.current.offsetWidth + 12)}px`); 
  }, [value, placeholder]);

  return (
    <div className="relative max-w-full flex items-center no-drag">
        <span ref={spanRef} className={`absolute opacity-0 pointer-events-none whitespace-pre px-1 ${className}`} style={style} aria-hidden="true">{value || placeholder || ''}</span>
        <input value={value} onChange={onChange} placeholder={placeholder} autoFocus={autoFocus} onBlur={onBlur} onClick={(e) => e.stopPropagation()} onMouseDown={(e) => e.stopPropagation()} draggable="true" onDragStart={(e) => { e.preventDefault(); e.stopPropagation(); }} className={`bg-transparent border border-transparent hover:border-gray-400/50 rounded px-1 -ml-1 transition-all outline-none cursor-text truncate ${className}`} style={{ ...style, width }} />
    </div>
  );
};

const GroupHeaderRow = ({ darkMode }) => (
    <div className={`flex border-b text-xs font-bold text-gray-500 uppercase tracking-wide ${darkMode ? 'bg-[#181b34] border-[#343856]' : 'bg-white border-[#bec3d4]'}`}>
        <div className={`w-10 border-r flex items-center justify-center py-2 ${darkMode ? 'border-[#343856]' : 'border-[#bec3d4]'}`}><Square size={14} className="opacity-50" /></div>
        <div className={`w-[450px] border-r px-4 py-2 flex items-center ${darkMode ? 'border-[#343856]' : 'border-[#bec3d4]'}`}>Item</div>
        <div className={`w-28 border-r px-4 py-2 flex items-center justify-center ${darkMode ? 'border-[#343856]' : 'border-[#bec3d4]'}`}>Person</div>
        <div className={`w-36 border-r px-4 py-2 flex items-center justify-center ${darkMode ? 'border-[#343856]' : 'border-[#bec3d4]'}`}>Status</div>
        <div className={`w-36 border-r px-4 py-2 flex items-center justify-center ${darkMode ? 'border-[#343856]' : 'border-[#bec3d4]'}`}>Type</div>
        <div className="w-48 px-4 py-2 flex items-center justify-center">Date</div>
    </div>
);

const LabelEditorModal = ({ isOpen, onClose, items, onSave, title, darkMode }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/50 backdrop-blur-sm" onClick={onClose}>
            <div className={`w-96 rounded-lg shadow-2xl p-6 ${darkMode ? 'bg-[#343856] text-white' : 'bg-white text-gray-800'}`} onClick={e => e.stopPropagation()}>
                <div className="flex justify-between items-center mb-4">
                    <h3 className="font-bold text-lg">{title}</h3>
                    <X className="cursor-pointer opacity-50 hover:opacity-100" onClick={onClose} size={20}/>
                </div>
                <div className="space-y-2 max-h-[300px] overflow-y-auto pr-2">
                    {items.map((item, idx) => (
                        <div key={item.id} className="flex gap-2 items-center">
                            <input type="color" value={item.color} onChange={(e) => {
                                const newItems = [...items];
                                newItems[idx].color = e.target.value;
                                onSave(newItems);
                            }} className="w-8 h-8 rounded cursor-pointer bg-transparent border-0" />
                            <input type="text" value={item.label} onChange={(e) => {
                                const newItems = [...items];
                                newItems[idx].label = e.target.value;
                                onSave(newItems);
                            }} className={`flex-1 px-2 py-1.5 rounded border ${darkMode ? 'bg-[#181b34] border-[#3d4058]' : 'bg-gray-50 border-gray-300'}`} />
                        </div>
                    ))}
                </div>
                <div className="mt-4 pt-4 border-t flex justify-end">
                    <button onClick={onClose} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium">Done</button>
                </div>
            </div>
        </div>
    );
};

// --- Dropdowns & Modals ---
const StatusDropdown = ({ statuses, currentStatusId, onSelect, darkMode, onEdit }) => (
    <div className={`rounded-md shadow-xl border overflow-hidden animate-in fade-in zoom-in-95 duration-100 ${darkMode ? 'bg-[#343856] border-[#3d4058]' : 'bg-white border-gray-300'}`}>
        {statuses.map(s => (
            <div key={s.id} onClick={(e) => { e.stopPropagation(); onSelect(s.id); }} className={`px-3 py-2 text-xs font-medium cursor-pointer flex items-center gap-2 transition-colors ${darkMode ? 'hover:bg-[#1c213e] text-white' : 'hover:bg-gray-50 text-gray-800'}`}>
                <div className="w-4 h-4 rounded shrink-0" style={{ backgroundColor: s.color }}></div>
                <span className="flex-1">{s.label}</span>
                {s.id === currentStatusId && <Check size={12} className="opacity-50" />}
            </div>
        ))}
        <div onClick={(e) => { e.stopPropagation(); onEdit(); }} className={`px-3 py-2 text-xs border-t cursor-pointer flex items-center gap-2 transition-colors ${darkMode ? 'border-[#3d4058] hover:bg-[#1c213e] text-blue-400' : 'border-gray-100 hover:bg-gray-50 text-blue-600'}`}><Edit2 size={12} /> Edit Labels</div>
    </div>
);

const TypeDropdown = ({ jobTypes, currentTypeId, onSelect, darkMode, onEdit }) => (
    <div className={`rounded-md shadow-xl border overflow-hidden animate-in fade-in zoom-in-95 duration-100 ${darkMode ? 'bg-[#343856] border-[#3d4058]' : 'bg-white border-gray-300'}`}>
        {jobTypes.map(t => (
            <div key={t.id} onClick={(e) => { e.stopPropagation(); onSelect(t.id); }} className={`px-3 py-2 text-xs font-medium cursor-pointer flex items-center gap-2 transition-colors ${darkMode ? 'hover:bg-[#1c213e] text-white' : 'hover:bg-gray-50 text-gray-800'}`}>
                <div className="w-4 h-4 rounded shrink-0" style={{ backgroundColor: t.color }}></div>
                <span className="flex-1">{t.label}</span>
                {t.id === currentTypeId && <Check size={12} className="opacity-50" />}
            </div>
        ))}
        <div onClick={(e) => { e.stopPropagation(); onEdit(); }} className={`px-3 py-2 text-xs border-t cursor-pointer flex items-center gap-2 transition-colors ${darkMode ? 'border-[#3d4058] hover:bg-[#1c213e] text-blue-400' : 'border-gray-100 hover:bg-gray-50 text-blue-600'}`}><Edit2 size={12} /> Edit Labels</div>
    </div>
);

const DatePicker = ({ datePickerOpen, setDatePickerOpen, darkMode, updateTaskDate }) => {
    if (!datePickerOpen) return null;
    const { projectId, taskId, subitemId, start, duration, el } = datePickerOpen;
    const rect = el.getBoundingClientRect();
    const top = Math.min(window.innerHeight - 300, rect.bottom + 5);
    const left = Math.min(window.innerWidth - 300, rect.left);

    const handleDateSelect = (relIndex) => {
        const newDur = duration || 1;
        updateTaskDate(projectId, taskId, subitemId, relIndex, newDur);
    };

    return (
        <>
          <div className="fixed inset-0 z-[110]" onClick={() => setDatePickerOpen(null)}></div>
          <div className={`fixed z-[120] w-64 rounded-lg shadow-2xl border p-3 flex flex-col gap-2 ${darkMode ? 'bg-[#343856] border-[#3d4058] text-white' : 'bg-white border-gray-300 text-gray-800'}`} style={{ top, left }}>
              <div className="flex items-center justify-between text-xs font-bold uppercase tracking-wide text-gray-500 mb-2">
                  <span>Select Start Date</span>
                  <span className="cursor-pointer hover:text-red-500" onClick={() => updateTaskDate(projectId, taskId, subitemId, null, null)}><Trash2 size={12}/> Clear</span>
              </div>
              <div className="grid grid-cols-7 gap-1">
                  {['S','M','T','W','T','F','S'].map((d,i) => <div key={i} className="text-[10px] text-center opacity-50">{d}</div>)}
                  {Array.from({length: 28}).map((_, i) => {
                      const d = new Date();
                      d.setDate(d.getDate() + i); 
                      const relIdx = getRelativeFromDate(d);
                      const isSelected = start === relIdx;
                      return (
                          <div key={i} onClick={() => handleDateSelect(relIdx)} className={`h-7 w-7 rounded flex items-center justify-center text-xs cursor-pointer transition-colors ${isSelected ? 'bg-blue-600 text-white' : (darkMode ? 'hover:bg-white/10' : 'hover:bg-gray-100')}`}>{d.getDate()}</div>
                      )
                  })}
              </div>
          </div>
        </>
    );
};

// ==========================================
// 4. TASK ROW COMPONENT (Used in Board & Gantt Sidebar)
// ==========================================

const TaskRow = ({ 
    task, projectId, parentId, isSubitem, isDragging, onDragStart, onDragOver, onDrop, onDragEnd, 
    isSelected, onToggle, onAddSubitem, activeTab, darkMode, statuses, jobTypes, 
    expandedItems, toggleItemExpand, updateTaskName, updateSubitemName,
    setStatusMenuOpen, setStatusMenuType, setDatePickerOpen, 
    statusMenuOpen, statusMenuType, currentStatusId, currentTypeId,
    onStatusSelect, onTypeSelect, onEditLabels, reorderDrag
}) => {
    const statusColor = statuses.find(s => s.id === task.status)?.color || '#c4c4c4';
    const statusLabel = statuses.find(s => s.id === task.status)?.label || 'Status';
    const typeColor = jobTypes.find(t => t.id === task.jobTypeId)?.color || '#c4c4c4';
    const typeLabel = jobTypes.find(t => t.id === task.jobTypeId)?.label || 'Type';
    
    const isBoard = activeTab === 'board';
    const hasSubitems = task.subitems && task.subitems.length > 0;
    const containerStyle = isDragging 
        ? `flex border-b items-center h-10 ${darkMode ? 'bg-blue-500/10 border-blue-500/50' : 'bg-blue-50 border-blue-300'} border-dashed opacity-50` 
        : `flex border-b transition-colors items-center h-10 group ${darkMode ? 'border-[#343856] hover:bg-[#202336] bg-[#1c213e]' : 'border-[#eceff8] hover:bg-[#f0f0f0] bg-white'}`;
    
    const handleDragStart = (e) => {
        if (['INPUT', 'SELECT', 'BUTTON', 'TEXTAREA'].includes(e.target.tagName) || e.target.closest('.no-drag')) {
            e.preventDefault();
            return;
        }
        if (onDragStart) onDragStart(e, isSubitem ? 'subitem' : 'task', task.id);
    };

    return (
        <div className={containerStyle} draggable="true" onDragStart={handleDragStart} onDragOver={onDragOver} onDrop={onDrop} onDragEnd={onDragEnd}>
            <div className={`w-10 border-r h-full flex items-center justify-center relative no-drag ${darkMode ? 'border-[#343856]' : 'border-[#eceff8]'}`} onMouseDown={(e) => e.stopPropagation()} onClick={(e) => e.stopPropagation()}>
                <div className={`cursor-pointer transition-all duration-200 ${isSelected ? 'text-blue-500 opacity-100' : 'text-gray-400 opacity-50 group-hover:opacity-100 hover:opacity-100'}`} onClick={(e) => { e.stopPropagation(); onToggle(task.id); }}>
                    {isSelected ? <CheckSquare size={16} /> : <Square size={16} />}
                </div>
            </div>
            
            <div className={`w-[450px] border-r h-full flex items-center px-4 relative ${darkMode ? 'border-[#343856]' : 'border-[#eceff8]'}`}>
                <div className={`flex items-center gap-2 w-full ${isSubitem ? 'pl-10' : ''}`}>
                    {isSubitem && <CornerDownRight size={12} className="text-gray-400 shrink-0" />}
                    {!isSubitem && (
                        <div onClick={hasSubitems ? () => toggleItemExpand(task.id) : undefined} className={`mr-2 transition-colors ${hasSubitems ? 'cursor-pointer text-gray-400 hover:text-blue-500' : 'cursor-default text-gray-300 opacity-30'} ${expandedItems.includes(task.id) ? 'rotate-90' : ''}`}>
                            <ChevronRight size={14} />
                        </div>
                    )}
                    <EditableText value={task.name} onChange={(e) => isSubitem ? updateSubitemName(projectId, parentId, task.id, e.target.value) : updateTaskName(projectId, task.id, e.target.value)} className={`text-sm ${darkMode ? 'text-gray-200' : 'text-[#323338]'}`} />
                    {!isSubitem && (
                        <div className="flex items-center gap-2 ml-auto no-drag">
                            {hasSubitems && <span className="text-[10px] bg-gray-200 text-gray-600 px-1.5 rounded-full">{task.subitems.length}</span>}
                            <button onClick={(e) => { e.stopPropagation(); onAddSubitem(projectId, task.id); }} className="p-1 rounded hover:bg-gray-200 text-gray-400 hover:text-blue-600 transition-colors" title="Add Subitem"><Plus size={14} /></button>
                        </div>
                    )}
                </div>
            </div>

            {isBoard && (
              <>
                 <div className={`w-28 border-r h-full flex items-center justify-center ${darkMode ? 'border-[#343856]' : 'border-[#eceff8]'}`}><div className="w-6 h-6 rounded-full bg-gray-400 text-[10px] flex items-center justify-center text-white border-2 border-transparent shadow-sm">{task.assignee?.charAt(0)}</div></div>
                 <div className={`w-36 border-r h-full flex items-center justify-center px-2 relative ${darkMode ? 'border-[#343856]' : 'border-[#eceff8]'}`}>
                     <div onClick={(e) => { e.stopPropagation(); setStatusMenuOpen(task.id); setStatusMenuType('status'); }} className="w-full h-8 flex items-center justify-center text-xs font-medium text-white rounded-sm cursor-pointer transition hover:opacity-90" style={{ backgroundColor: statusColor }}>{statusLabel}</div>
                     {!isDragging && statusMenuOpen === task.id && statusMenuType === 'status' && (<div className="z-50 absolute top-full w-full left-0 z-[100]"><StatusDropdown statuses={statuses} currentStatusId={task.status} onSelect={(id) => onStatusSelect(projectId, task.id, isSubitem ? task.id : null, id)} darkMode={darkMode} onEdit={onEditLabels} /></div>)}
                 </div>
                 <div className={`w-36 border-r h-full flex items-center justify-center px-2 relative ${darkMode ? 'border-[#343856]' : 'border-[#eceff8]'}`}>
                     <div onClick={(e) => { e.stopPropagation(); setStatusMenuOpen(task.id); setStatusMenuType('type'); }} className="w-full h-8 flex items-center justify-center text-xs font-medium text-white rounded-sm cursor-pointer transition hover:opacity-90" style={{ backgroundColor: typeColor }}>{typeLabel}</div>
                     {!isDragging && statusMenuOpen === task.id && statusMenuType === 'type' && (<div className="z-50 absolute top-full w-full left-0 z-[100]"><TypeDropdown jobTypes={jobTypes} currentTypeId={task.jobTypeId} onSelect={(id) => onTypeSelect(projectId, task.id, isSubitem ? task.id : null, id)} darkMode={darkMode} onEdit={onEditLabels} /></div>)}
                 </div>
                 <div className={`w-48 h-full flex items-center justify-center px-4 cursor-pointer relative ${darkMode ? 'hover:bg-white/5' : ''}`} onClick={(e) => !isDragging && setDatePickerOpen({ projectId: projectId, taskId: task.id, subitemId: isSubitem ? task.id : null, start: task.start, duration: task.duration, el: e.currentTarget })}>
                    {task.start !== null ? <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{getFutureDate(task.start)} - {getFutureDate(task.start + task.duration)}</span> : <div className={`px-2 py-1 rounded border border-dashed text-[10px] ${darkMode ? 'border-gray-600 text-gray-500' : 'border-gray-300 text-gray-400'}`}>Set Dates</div>}
                 </div>
              </>
            )}
            
            {reorderDrag.active && reorderDrag.dropTargetId === task.id && (<div className="absolute left-0 right-0 h-0.5 bg-blue-500 z-50 pointer-events-none" style={{ top: reorderDrag.dropPosition === 'before' ? '-1px' : 'auto', bottom: reorderDrag.dropPosition === 'after' ? '-1px' : 'auto' }} />)}
        </div>
    );
};

// ==========================================
// 5. VIEW COMPONENTS
// ==========================================

const Sidebar = ({ darkMode, workspaces, dashboards, activeEntityId, setActiveEntityId, createWorkspace, createDashboard, setDarkMode }) => (
    <div className={`w-64 border-r flex flex-col hidden md:flex ${darkMode ? 'bg-[#111322] border-[#343856]' : 'bg-white border-[#bec3d4]'}`}>
        <div className={`p-4 border-b ${darkMode ? 'border-[#343856]' : 'border-[#bec3d4]'} `}><h2 className="font-bold text-lg">Workspace</h2></div>
        <div className="flex-1 overflow-y-auto p-3 space-y-6">
           <div>
             <div className="flex items-center justify-between text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 px-2"><span>Boards</span><Plus size={14} className="cursor-pointer hover:text-blue-500" onClick={createWorkspace} /></div>
             <div className="space-y-1">{workspaces.map(w => (<div key={w.id} onClick={() => setActiveEntityId(w.id)} className={`flex items-center gap-3 px-3 py-2 rounded-md text-sm cursor-pointer transition-colors ${activeEntityId === w.id ? (darkMode ? 'bg-[#1c213e] text-blue-400' : 'bg-blue-50 text-blue-600') : (darkMode ? 'hover:bg-[#1c213e] text-gray-400' : 'hover:bg-gray-100 text-gray-700')}`}><Briefcase size={16} /><span className="truncate font-medium">{w.name}</span></div>))}</div>
           </div>
           <div>
             <div className="flex items-center justify-between text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 px-2"><span>Dashboards</span><Plus size={14} className="cursor-pointer hover:text-blue-500" onClick={createDashboard} /></div>
             <div className="space-y-1">{dashboards.map(d => (<div key={d.id} onClick={() => setActiveEntityId(d.id)} className={`flex items-center gap-3 px-3 py-2 rounded-md text-sm cursor-pointer transition-colors ${activeEntityId === d.id ? (darkMode ? 'bg-[#1c213e] text-purple-400' : 'bg-purple-50 text-purple-600') : (darkMode ? 'hover:bg-[#1c213e] text-gray-400' : 'hover:bg-gray-100 text-gray-700')}`}><LayoutDashboard size={16} /><span className="truncate font-medium">{d.name}</span></div>))}</div>
           </div>
        </div>
        <div className={`p-4 border-t ${darkMode ? 'border-[#343856]' : 'border-[#bec3d4]'} flex items-center justify-between`}>
             <span className="text-xs text-gray-500">Theme</span>
             <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-full ${darkMode ? 'bg-[#343856] text-yellow-400' : 'bg-gray-100 text-gray-600'}`}>{darkMode ? <Sun size={16} /> : <Moon size={16} />}</button>
        </div>
    </div>
);

const AppHeader = ({ activeEntity, activeTab, setActiveTab, darkMode, setSettingsMenuOpen, settingsMenuOpen, showWeekends, setShowWeekends, showLabels, setShowLabels, colorBy, setColorBy, zoomLevel, handleZoomChange, rowHeight, setRowHeight, isChatOpen, setIsChatOpen, scrollToToday, updateEntityName, onExport, onExportJson, onImportJson }) => (
    <>
        <div className={`h-16 border-b px-8 flex items-center justify-between shrink-0 ${darkMode ? 'border-[#343856] bg-[#181b34]' : 'border-[#bec3d4] bg-white'}`}>
          <div>
            <div className="flex items-center gap-3 text-2xl font-bold">
              {activeEntity.type === 'workspace' ? <Briefcase className="text-gray-400" /> : <LayoutDashboard className="text-purple-500" />}
              <EditableText value={activeEntity.name} onChange={(e) => updateEntityName(e.target.value)} className={`hover:bg-opacity-10 px-2 -ml-2 rounded ${darkMode ? 'text-white hover:bg-white' : 'hover:bg-gray-800'}`} />
            </div>
          </div>
        </div>
        <div className={`px-8 border-b flex items-center justify-between shrink-0 sticky top-0 z-30 ${darkMode ? 'border-[#343856] bg-[#181b34]' : 'border-[#bec3d4] bg-white'}`}>
           <div className="flex gap-6">
            <button onClick={() => setActiveTab('board')} className={`py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'board' ? 'border-[#0073ea] text-[#0073ea]' : 'border-transparent text-gray-500'}`}>Main Table</button>
            <button onClick={() => setActiveTab('gantt')} className={`py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'gantt' ? 'border-[#0073ea] text-[#0073ea]' : 'border-transparent text-gray-500'}`}>Gantt</button>
          </div>
          <div className="flex items-center gap-6">
            {activeTab === 'gantt' && (
              <div className="flex gap-4">
                  <button onClick={() => scrollToToday(true)} className={`flex items-center gap-2 text-xs font-medium px-3 py-1.5 rounded-full border transition-colors ${darkMode ? 'bg-[#1c213e] border-[#343856] text-gray-300 hover:bg-[#202336]' : 'bg-white border-gray-300 text-gray-600 hover:bg-gray-100'}`}><Target size={14} /> Today</button>
                  <div className="relative">
                     <button onClick={(e) => { e.stopPropagation(); setSettingsMenuOpen(!settingsMenuOpen); }} className={`flex items-center gap-2 text-xs font-medium px-3 py-1.5 rounded-full border transition-colors ${settingsMenuOpen || !darkMode ? 'bg-white text-gray-700 border-gray-300' : 'bg-[#1c213e] border-[#343856] text-gray-300'}`}><Settings size={14} /> Settings</button>
                     {settingsMenuOpen && (
                         <div className={`absolute top-full right-0 mt-2 w-56 rounded-lg shadow-xl border z-[100] p-2 animate-in fade-in zoom-in-95 duration-100 ${darkMode ? 'bg-[#343856] border-[#3d4058]' : 'bg-white border-gray-300'}`} onClick={e => e.stopPropagation()}>
                             <div className="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide px-2">View Options</div>
                             <div className={`flex items-center justify-between p-2 rounded cursor-pointer ${darkMode ? 'hover:bg-[#1c213e]' : 'hover:bg-gray-50'}`} onClick={() => setShowWeekends(!showWeekends)}>
                                 <span className={`text-sm ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>Show Weekends</span>
                                 <div className={`w-8 h-4 rounded-full relative transition-colors ${showWeekends ? 'bg-blue-600' : 'bg-gray-400'}`}><div className={`absolute top-0.5 left-0.5 w-3 h-3 rounded-full bg-white transition-transform ${showWeekends ? 'translate-x-4' : 'translate-x-0'}`}></div></div>
                             </div>
                             <div className={`flex items-center justify-between p-2 rounded cursor-pointer ${darkMode ? 'hover:bg-[#1c213e]' : 'hover:bg-gray-50'}`} onClick={() => setShowLabels(!showLabels)}>
                                 <span className={`text-sm ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>Show Labels</span>
                                 <div className={`w-8 h-4 rounded-full relative transition-colors ${showLabels ? 'bg-blue-600' : 'bg-gray-400'}`}><div className={`absolute top-0.5 left-0.5 w-3 h-3 rounded-full bg-white transition-transform ${showLabels ? 'translate-x-4' : 'translate-x-0'}`}></div></div>
                             </div>
                             <div className="border-t border-gray-600 my-2 opacity-20"></div>
                             <div className="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide px-2">Color Bars By</div>
                             <div className="flex bg-black/10 p-1 rounded">
                                 <button onClick={() => setColorBy('status')} className={`flex-1 py-1 text-xs rounded text-center transition-colors ${colorBy === 'status' ? (darkMode ? 'bg-[#1c213e] text-white shadow' : 'bg-white text-black shadow') : 'text-gray-500'}`}>Status</button>
                                 <button onClick={() => setColorBy('type')} className={`flex-1 py-1 text-xs rounded text-center transition-colors ${colorBy === 'type' ? (darkMode ? 'bg-[#1c213e] text-white shadow' : 'bg-white text-black shadow') : 'text-gray-500'}`}>Type</button>
                             </div>
                             <div className="border-t border-gray-600 my-2 opacity-20"></div>
                             <div className={`flex items-center justify-between p-2 rounded cursor-pointer ${darkMode ? 'hover:bg-[#1c213e]' : 'hover:bg-gray-50'}`} onClick={onExport}>
                                 <span className={`text-sm flex items-center gap-2 ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}><Download size={14} /> Export CSV</span>
                             </div>
                             <div className={`flex items-center justify-between p-2 rounded cursor-pointer ${darkMode ? 'hover:bg-[#1c213e]' : 'hover:bg-gray-50'}`} onClick={onExportJson}>
                                 <span className={`text-sm flex items-center gap-2 ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}><FileText size={14} /> Backup (JSON)</span>
                             </div>
                             <label className={`flex items-center justify-between p-2 rounded cursor-pointer ${darkMode ? 'hover:bg-[#1c213e]' : 'hover:bg-gray-50'}`}>
                                 <span className={`text-sm flex items-center gap-2 ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}><Upload size={14} /> Restore (JSON)</span>
                                 <input type="file" accept=".json" className="hidden" onChange={onImportJson} />
                             </label>
                         </div>
                     )}
                  </div>
                 <div className={`flex items-center gap-3 px-3 py-1.5 rounded-full border ${darkMode ? 'bg-[#1c213e] border-[#343856] text-gray-300' : 'bg-gray-50 border-gray-300 text-gray-600'}`}><ZoomOut size={14} /><input type="range" min="10" max="100" value={zoomLevel} onChange={handleZoomChange} className="w-20 h-1 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-[#0073ea]" /><ZoomIn size={14} /></div>
                 <div className={`flex items-center gap-3 px-3 py-1.5 rounded-full border ${darkMode ? 'bg-[#1c213e] border-[#343856] text-gray-300' : 'bg-gray-50 border-gray-300 text-gray-600'}`}><ArrowUpDown size={14} /><input type="range" min="32" max="80" value={rowHeight} onChange={(e) => setRowHeight(Number(e.target.value))} className="w-20 h-1 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-[#0073ea]" /></div>
              </div>
            )}
            {!isChatOpen && <button onClick={() => setIsChatOpen(true)} className="flex items-center gap-2 text-sm text-[#0073ea] font-medium hover:bg-blue-50 px-3 py-1 rounded"><MessageSquare size={16} /> Open AI Chat</button>}
          </div>
        </div>
    </>
);

// --- BOARD VIEW ---
const BoardView = (props) => {
    const { visibleProjects, collapsedGroups, toggleGroupCollapse, updateGroupName, statuses, darkMode, addTaskToGroup, addGroup, activeTab } = props;
    
    return (
        <div className={`flex-1 overflow-auto pb-40 ${darkMode ? 'bg-[#181b34]' : 'bg-[#f5f6f8]'}`}>
            {visibleProjects.map(proj => {
                const defaultGroups = proj.groups || [{ id: 'default', name: 'Main Group', color: '#579bfc' }];
                return (
                    <div key={proj.id} className="mb-10 px-8 mt-8">
                         {defaultGroups.map(group => {
                             const groupTasks = proj.tasks.filter(t => t.groupId === group.id || (!t.groupId && group.id === 'default'));
                             const isGroupCollapsed = collapsedGroups.includes(group.id);

                             return (
                                 <div key={group.id} className="mb-8">
                                     <div className="flex items-center gap-2 mb-2 group">
                                         <div onClick={() => toggleGroupCollapse(group.id)} className={`p-1 rounded cursor-pointer transition ${isGroupCollapsed ? '-rotate-90' : 'rotate-0'} ${darkMode ? 'hover:bg-[#343856]' : 'hover:bg-gray-100'}`}><ChevronDown size={18} style={{ color: group.color }} /></div>
                                         <EditableText value={group.name} onChange={(e) => updateGroupName(proj.id, group.id, e.target.value)} className="text-lg font-medium" style={{ color: group.color }} />
                                         <span className="text-xs text-gray-500 font-normal ml-2">{groupTasks.length} Items</span>
                                     </div>

                                     {!isGroupCollapsed ? (
                                         <div className={`shadow-sm border-l-4 rounded-tl-md rounded-bl-md overflow-visible ${darkMode ? 'border-[#343856]' : 'border-gray-300'}`} style={{ borderLeftColor: group.color }}>
                                             <GroupHeaderRow darkMode={darkMode} />
                                             {groupTasks.map((task) => {
                                                 const isExpanded = props.expandedItems.includes(task.id);
                                                 return (
                                                     <React.Fragment key={task.id}>
                                                         <TaskRow 
                                                             task={task} projectId={proj.id} isSubitem={false} isDragging={props.reorderDrag.active && props.reorderDrag.dragId === task.id}
                                                             onDragStart={props.handleRowDragStart} onDragOver={(e) => props.handleRowDragOver(e, 'task', task.id)} onDrop={props.handleRowDrop} onDragEnd={props.handleRowDragEnd}
                                                             isSelected={props.selectedItems.has(task.id)} onToggle={props.toggleSelection} onAddSubitem={props.handleAddSubitem}
                                                             {...props} // Pass through remaining props
                                                         />
                                                         {isExpanded && task.subitems.map((sub) => (
                                                             <TaskRow 
                                                                 key={sub.id} task={sub} projectId={proj.id} parentId={task.id} isSubitem={true} isDragging={props.reorderDrag.active && props.reorderDrag.dragId === sub.id}
                                                                 onDragStart={props.handleRowDragStart} onDragOver={(e) => props.handleRowDragOver(e, 'subitem', sub.id)} onDrop={props.handleRowDrop} onDragEnd={props.handleRowDragEnd}
                                                                 isSelected={props.selectedItems.has(sub.id)} onToggle={props.toggleSelection}
                                                                 {...props}
                                                             />
                                                         ))}
                                                     </React.Fragment>
                                                 );
                                             })}
                                             <div className={`flex h-10 items-center border-b ${darkMode ? 'border-[#343856] hover:bg-[#202336] bg-[#181b34]' : 'border-[#eceff8] hover:bg-[#f5f6f8] bg-white'}`}>
                                                 <div className={`w-10 border-r h-full ${darkMode ? 'border-[#343856]' : 'border-[#eceff8]'}`}></div>
                                                 <div className="w-[450px] px-4 flex items-center">
                                                     <input type="text" placeholder="+ Add Item" className={`w-full bg-transparent outline-none text-sm ${darkMode ? 'text-gray-400 placeholder-gray-600' : 'text-gray-500 placeholder-gray-400'}`} onKeyDown={(e) => { if (e.key === 'Enter' && e.target.value.trim()) { addTaskToGroup(proj.id, group.id, e.target.value); e.target.value = ''; }}} />
                                                 </div>
                                             </div>
                                         </div>
                                      ) : (
                                          <div className="h-10 flex items-center rounded-md overflow-hidden relative pl-4" style={{ backgroundColor: darkMode ? '#343856' : '#f0f0f0' }}>
                                              <div className="absolute left-0 top-0 bottom-0 w-1.5" style={{ backgroundColor: group.color }}></div>
                                              <div className="flex-1 flex h-full">{statuses.map(s => { const count = groupTasks.filter(t => t.status === s.id).length; if (count === 0) return null; const pct = (count / groupTasks.length) * 100; return <div key={s.id} style={{ width: `${pct}%`, backgroundColor: s.color }} title={`${s.label}: ${count}`} className="h-full first:rounded-l-none" />; })}</div>
                                              <div className={`w-32 flex items-center justify-center text-xs font-bold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{groupTasks.length} Items</div>
                                          </div>
                                       )}
                                  </div>
                             );
                         })}
                         <button onClick={() => addGroup(proj.id)} className={`flex items-center gap-2 text-sm font-medium px-4 py-2 rounded border transition-colors ${darkMode ? 'border-[#343856] hover:bg-[#343856] text-gray-300' : 'border-gray-300 hover:bg-gray-50 text-gray-600'}`}><Plus size={16} /> Add New Group</button>
                    </div>
                );
            })}
        </div>
    );
};

// --- GANTT VIEW ---
const GanttView = (props) => {
    const { 
        visibleProjects, collapsedGroups, toggleGroupCollapse, darkMode, rowHeight, 
        visibleDays, visibleMonths, zoomLevel, dayToVisualIndex, visualIndexToDayIndex, 
        showWeekends, showLabels, statuses, jobTypes, colorBy,
        dragState, handleMouseDown, handleRowDragStart, handleRowDragOver, handleRowDrop, handleRowDragEnd,
        reorderDrag, selectedItems, toggleSelection, handleAddSubitem, updateTaskName, addTaskToGroup,
        expandedItems, toggleItemExpand, updateSubitemName, setStatusMenuOpen, setStatusMenuType, setDatePickerOpen,
        onStatusSelect, onTypeSelect, onEditLabels
    } = props;

    const getTaskColor = (task) => {
        if (colorBy === 'status') return statuses.find(s => s.id === task.status)?.color || '#c4c4c4';
        return jobTypes.find(t => t.id === task.jobTypeId)?.color || '#c4c4c4';
    };

    return (
        <div ref={props.bodyRef} className={`flex-1 overflow-auto overflow-x-auto relative border-t ${darkMode ? 'bg-[#181b34] border-[#343856]' : 'bg-white border-[#bec3d4]'}`}>
             <div className={`flex border-b sticky top-0 z-40 shadow-sm ${darkMode ? 'bg-[#181b34] border-[#343856]' : 'bg-white border-[#bec3d4]'}`} style={{ width: `calc(20rem + ${visibleDays.length * zoomLevel}px)` }}>
                <div className={`w-80 border-r p-3 font-medium text-sm pl-6 sticky left-0 z-50 flex-shrink-0 ${darkMode ? 'bg-[#1c213e] border-[#343856] text-gray-300' : 'bg-[#f9fafc] border-[#bec3d4] text-gray-500'}`}>Project / Task</div>
                <div className="flex flex-col flex-1">
                    <div className={`flex h-8 border-b ${darkMode ? 'border-[#343856]' : 'border-[#eceff8]'}`}>
                        {visibleMonths.map((month, i) => (
                            <div key={i} className={`flex-shrink-0 border-r flex items-center justify-center text-xs font-bold uppercase tracking-wide text-gray-400`} style={{ width: `${month.count * zoomLevel}px`, background: darkMode ? `linear-gradient(to right, #2b304a, #181b34)` : `linear-gradient(to right, #f9fafc, #e2e8f0)` }}>{month.name}</div>
                        ))}
                    </div>
                    <div className="flex h-10">
                        {visibleDays.map((day, i) => {
                            const prevDay = visibleDays[i-1];
                            const isGap = !showWeekends && prevDay && day.index > prevDay.index + 1;
                            const dayLetter = zoomLevel >= 40 ? day.dayName.charAt(0) : null;
                            const showWeekRange = zoomLevel < 20 && (day.isMonday || i === 0);
                            return (
                                <div key={i} className={`flex-shrink-0 border-r flex flex-col items-center justify-center text-gray-400 relative ${darkMode ? 'border-white/5 ' + (day.isWeekend?'bg-[#151726]':'bg-[#181b34]') : 'border-[#eceff8] ' + (day.isWeekend?'bg-slate-50':'bg-white')} ${isGap ? (darkMode ? 'border-l-2 border-l-[#3d4058]' : 'border-l-2 border-l-gray-300') : ''} ${day.isToday ? 'bg-blue-600 text-white' : ''}`} style={{ width: `${zoomLevel}px` }}>
                                    {showWeekRange && (<div className="absolute top-0 left-0 w-max pl-1 text-[10px] font-bold whitespace-nowrap z-10 pointer-events-none opacity-50">{day.weekLabel}</div>)}
                                    {zoomLevel >= 20 && (<span className={`font-semibold leading-none ${day.isToday ? 'text-white' : ''}`} style={{ fontSize: `${Math.max(10, Math.min(14, zoomLevel * 0.4))}px` }}>{day.dayNum}</span>)}
                                    {dayLetter && (<span className="text-[9px] mt-0.5 opacity-60">{dayLetter}</span>)}
                                </div>
                            );
                        })}
                    </div>
                </div>
             </div>

             <div style={{ width: `calc(20rem + ${visibleDays.length * zoomLevel}px)` }}>
                {visibleProjects.map((project) => {
                     const projectGroups = project.groups || [{ id: 'default', name: 'Main Group', color: '#579bfc' }];
                     return (
                        <div key={project.id} className={`border-b group/project ${darkMode ? 'border-[#343856] bg-[#181b34]' : 'border-[#eceff8] bg-white'}`}>
                            {projectGroups.map(group => {
                                const groupTasks = project.tasks.filter(t => t.groupId === group.id || (!t.groupId && group.id === 'default'));
                                const isGroupCollapsed = collapsedGroups.includes(group.id);
                                return (
                                    <div key={group.id}>
                                        <div className="flex relative transition-colors duration-200" style={{ height: `${rowHeight}px`, backgroundColor: group.color + (darkMode ? '33' : '1A') }}>
                                            <div className={`w-80 border-r px-4 flex items-center gap-2 sticky left-0 z-40 cursor-pointer flex-shrink-0 transition-colors ${darkMode ? 'border-[#343856] text-gray-200' : 'border-[#bec3d4] text-gray-700'}`} onClick={() => toggleGroupCollapse(group.id)} style={{ background: `linear-gradient(${group.color}${darkMode ? '33' : '1A'}, ${group.color}${darkMode ? '33' : '1A'}), ${darkMode ? '#181b34' : '#ffffff'}` }}>
                                                <div className={`p-1 rounded transition ${isGroupCollapsed ? '-rotate-90' : 'rotate-0'}`}><ChevronDown size={16} style={{ color: group.color }} /></div>
                                                <span className="font-bold text-sm" style={{ color: group.color }}>{group.name}</span>
                                                <span className="text-xs opacity-50 ml-2 font-normal">({groupTasks.length})</span>
                                            </div>
                                            <div className="relative flex-1 h-full"><div className="absolute inset-0 flex pointer-events-none z-0">{visibleDays.map((day, i) => (<div key={i} className={`h-full border-r ${darkMode ? 'border-white/5' : 'border-[#eceff8]'} ${day.isWeekend ? 'bg-black/20' : 'bg-transparent'} ${day.isToday ? 'bg-blue-500/10' : ''} ${!showWeekends && i > 0 && day.index > visibleDays[i-1].index + 1 ? (darkMode ? 'border-l-2 border-l-[#3d4058]' : 'border-l-2 border-l-gray-300') : ''}`} style={{ width: `${zoomLevel}px`, minWidth: `${zoomLevel}px` }}>
                                                {day.isToday && <div className="absolute top-0 bottom-0 left-0 w-0.5 bg-blue-500 z-10 opacity-50"></div>}
                                                {day.isEndOfWeekToday && <div className="absolute top-0 bottom-0 right-0 w-0.5 bg-blue-500 z-10"></div>}
                                            </div>))}</div></div>
                                        </div>

                                        {!isGroupCollapsed && groupTasks.map(task => {
                                            const isExpanded = expandedItems.includes(task.id);
                                            const hasSubitems = task.subitems && task.subitems.length > 0;
                                            const isDragging = reorderDrag.active && reorderDrag.dragId === task.id;
                                            const isDeleting = dragState.isDeleteMode && dragState.taskId === task.id && !dragState.subitemId;
                                            
                                            // TaskRow Props Passthrough
                                            const taskRowProps = { task, projectId: project.id, isSubitem: false, isDragging: false, onDragStart: (e) => handleRowDragStart(e, 'task', task.id, null, project.id, group.id), onDragEnd: handleRowDragEnd, isSelected: selectedItems.has(task.id), onToggle: toggleSelection, onAddSubitem: handleAddSubitem, activeTab: 'gantt', darkMode, statuses, jobTypes, expandedItems, toggleItemExpand, updateTaskName, updateSubitemName, setStatusMenuOpen, setStatusMenuType, setDatePickerOpen, onStatusSelect, onTypeSelect, onEditLabels, reorderDrag };

                                            const parentRowSegments = (() => {
                                                if (!hasSubitems || isExpanded) return null;
                                                const validItems = task.subitems.map(sub => {
                                                    if (sub.start === null) return null;
                                                    const start = dayToVisualIndex[sub.start];
                                                    const endDayIndex = sub.start + sub.duration;
                                                    let end = dayToVisualIndex[endDayIndex];
                                                    if (end === undefined) end = visibleDays.length;
                                                    if (start === undefined) return null;
                                                    const color = getTaskColor(sub);
                                                    return { start, end, color, id: sub.id, name: sub.name, originalObj: sub, duration: sub.duration };
                                                }).filter(Boolean);
                                                if (validItems.length === 0) return null;
                                                validItems.sort((a, b) => a.start - b.start);
                                                const lanes = [];
                                                const layout = validItems.map(item => {
                                                    let laneIndex = -1;
                                                    for (let l = 0; l < lanes.length; l++) { if (lanes[l] <= item.start) { laneIndex = l; break; } }
                                                    if (laneIndex === -1) { laneIndex = lanes.length; lanes.push(item.end); } else { lanes[laneIndex] = item.end; }
                                                    return { ...item, laneIndex };
                                                });
                                                return { items: layout, maxLanes: lanes.length };
                                            })();

                                            return (
                                                <React.Fragment key={task.id}>
                                                    <div className={`flex border-b relative group/task ${isExpanded ? (darkMode ? 'bg-[#151726]' : 'bg-gray-100') : (darkMode ? 'bg-[#181b34] hover:bg-[#202336]' : 'bg-white hover:bg-[#f9fafc]')} ${darkMode ? 'border-[#343856]' : 'border-[#eceff8]'}`} style={{ height: `${rowHeight}px` }}>
                                                        <div className={`w-80 border-r flex-shrink-0 sticky left-0 z-30 ${darkMode ? 'border-[#343856] bg-inherit text-gray-300' : 'border-[#bec3d4] bg-inherit text-gray-800'}`} onDragOver={(e) => handleRowDragOver(e, 'task', task.id)} onDrop={handleRowDrop} style={{ opacity: isDragging ? 0.5 : 1, transition: 'opacity 0.2s' }}>
                                                            <TaskRow {...taskRowProps} />
                                                            {reorderDrag.active && reorderDrag.dropTargetId === task.id && (<div className="absolute left-0 right-0 h-0.5 bg-blue-500 z-50 pointer-events-none" style={{ top: reorderDrag.dropPosition === 'before' ? '-1px' : 'auto', bottom: reorderDrag.dropPosition === 'after' ? '-1px' : 'auto' }} />)}
                                                        </div>
                                                        
                                                        <div className="relative flex-1 h-full" onMouseDown={(e) => handleMouseDown(e, task, project.id, 'create', null, 'parent')}>
                                                                <div className="absolute inset-0 flex pointer-events-none z-0">{visibleDays.map((day, i) => (<div key={i} className={`h-full border-r ${darkMode ? 'border-white/5' : 'border-[#eceff8]'} ${day.isWeekend ? 'bg-black/20' : 'bg-transparent'} ${!showWeekends && i > 0 && day.index > visibleDays[i-1].index + 1 ? (darkMode ? 'border-l-2 border-l-[#3d4058]' : 'border-l-2 border-l-gray-300') : ''} ${day.isToday ? 'bg-blue-500/10' : ''}`} style={{ width: `${zoomLevel}px`, minWidth: `${zoomLevel}px` }}></div>))}</div>
                                                                {dragState.type === 'create' && dragState.taskId === task.id && !dragState.subitemId && (<div className="absolute top-1/2 -translate-y-1/2 h-2/3 rounded-md shadow-sm border-2 border-dashed border-blue-400 bg-blue-400/20 z-10 pointer-events-none" style={{ left: `${dayToVisualIndex[dragState.originalStart] * zoomLevel}px`, width: `${dragState.currentSpan * zoomLevel}px` }} />)}
                                                                {dragState.isDeleteMode && dragState.taskId === task.id && dragState.origin === 'parent' && (<div className="absolute top-1/2 -translate-y-1/2 h-2/3 flex items-center justify-center z-50 pointer-events-none" style={{ left: `${dragState.currentVisualSlot * zoomLevel}px`, width: `${zoomLevel}px` }}><div className="bg-red-500 text-white p-1 rounded shadow-lg scale-75 animate-pulse"><Trash2 size={12} /></div></div>)}
                                                                
                                                                {/* PARENT ROW SEGMENTS (STACKED BARS) */}
                                                                {hasSubitems && !isExpanded && parentRowSegments && parentRowSegments.items.map((item) => (
                                                                    <div 
                                                                        key={item.id} 
                                                                        className={`absolute h-3/4 rounded-md shadow-sm z-20 flex items-center border overflow-hidden ${darkMode ? 'border-[#181b34]' : 'border-white'}`}
                                                                        style={{ 
                                                                            left: `${item.start * zoomLevel}px`, 
                                                                            width: `${Math.max((item.end - item.start) * zoomLevel, 0)}px`, 
                                                                            backgroundColor: item.color, 
                                                                            top: '50%',
                                                                            transform: 'translateY(-50%)',
                                                                            marginTop: `${(item.laneIndex * 6) - ((parentRowSegments.maxLanes - 1) * 3)}px`, 
                                                                            zIndex: 20 + item.laneIndex, 
                                                                            cursor: 'move'
                                                                        }} 
                                                                        onMouseDown={(e) => handleMouseDown(e, task, project.id, 'move', item.id, 'parent')}
                                                                    >
                                                                        {/* Resize Handles for Stacked Bars */}
                                                                        <div className="absolute left-0 top-0 bottom-0 w-2 cursor-ew-resize hover:bg-black/20 z-30" onMouseDown={(e) => handleMouseDown(e, task, project.id, 'resize-left', item.id, 'parent')}></div>
                                                                        <div className="absolute right-0 top-0 bottom-0 w-2 cursor-ew-resize hover:bg-black/20 z-30" onMouseDown={(e) => handleMouseDown(e, task, project.id, 'resize-right', item.id, 'parent')}></div>
                                                                        {zoomLevel > 15 && showLabels && <span className="truncate select-none pointer-events-none font-medium text-[9px] text-white pl-2 pr-1 block w-full text-left">{item.name}</span>}
                                                                    </div>
                                                                ))}

                                                                {task.start !== null && !hasSubitems && !isDeleting && (<div className={`absolute top-1/2 -translate-y-1/2 h-3/4 rounded-md shadow-sm flex items-center px-0 text-[9px] cursor-move group z-10 border overflow-hidden ${darkMode ? 'border-[#181b34]' : 'border-white'}`} style={{ left: `${dayToVisualIndex[task.start] * zoomLevel}px`, width: `${(dayToVisualIndex[task.start + task.duration] - dayToVisualIndex[task.start]) * zoomLevel}px`, backgroundColor: getTaskColor(task) }} onMouseDown={(e) => handleMouseDown(e, task, project.id, 'move', null, 'parent')}>
                                                                    {zoomLevel > 15 && showLabels && <span className="truncate select-none pointer-events-none font-medium block w-full text-white text-left pl-2 pr-1">{task.name}</span>}
                                                                    <div className="absolute left-0 top-0 bottom-0 w-3 cursor-ew-resize hover:bg-black/10 rounded-l-md" onMouseDown={(e) => handleMouseDown(e, task, project.id, 'resize-left', null, 'parent')}></div>
                                                                    <div className="absolute right-0 top-0 bottom-0 w-3 cursor-ew-resize hover:bg-black/10 rounded-r-md" onMouseDown={(e) => handleMouseDown(e, task, project.id, 'resize-right', null, 'parent')}></div>
                                                                </div>)}
                                                        </div>
                                                    </div>
                                                    {isExpanded && task.subitems.map(sub => {
                                                         const isSubDragging = reorderDrag.active && reorderDrag.dragId === sub.id;
                                                         const isSubDeleting = dragState.isDeleteMode && dragState.subitemId === sub.id;
                                                         const subRowProps = { ...taskRowProps, task: sub, parentId: task.id, isSubitem: true, onDragStart: (e) => handleRowDragStart(e, 'subitem', sub.id, null, task.id, group.id) };
                                                         
                                                         return (
                                                            <div key={sub.id} className={`flex h-10 items-center border-t relative ${darkMode ? 'border-[#343856] hover:bg-[#202336]' : 'border-[#eceff8] hover:bg-[#eceff8]'}`} onDragOver={(e) => handleRowDragOver(e, 'subitem', sub.id)} onDrop={handleRowDrop}>
                                                                    <div className={`w-80 border-r flex-shrink-0 sticky left-0 z-30 ${darkMode ? 'border-[#343856] bg-inherit text-gray-400' : 'border-[#bec3d4] bg-inherit text-gray-500'}`} onDragOver={(e) => handleRowDragOver(e, 'subitem', sub.id)} onDrop={handleRowDrop} style={{ opacity: isSubDragging ? 0.5 : 1, transition: 'opacity 0.2s' }}>
                                                                        <TaskRow {...subRowProps} />
                                                                        {reorderDrag.active && reorderDrag.dropTargetId === sub.id && (<div className="absolute left-0 right-0 h-0.5 bg-blue-500 z-50 pointer-events-none" style={{ top: reorderDrag.dropPosition === 'before' ? '-1px' : 'auto', bottom: reorderDrag.dropPosition === 'after' ? '-1px' : 'auto' }} />)}
                                                                    </div>
                                                                    <div className="relative flex-1 h-full" onMouseDown={(e) => handleMouseDown(e, task, project.id, 'create', sub.id, 'expanded')}>
                                                                            <div className="absolute inset-0 flex pointer-events-none z-0">{visibleDays.map((day, i) => (<div key={i} className={`h-full border-r ${darkMode ? 'border-white/5' : 'border-[#eceff8]'} ${day.isWeekend ? 'bg-black/20' : 'bg-transparent'} ${!showWeekends && i > 0 && day.index > visibleDays[i-1].index + 1 ? (darkMode ? 'border-l-2 border-l-[#3d4058]' : 'border-l-2 border-l-gray-300') : ''} ${day.isToday ? 'bg-blue-500/10' : ''}`} style={{ width: `${zoomLevel}px`, minWidth: `${zoomLevel}px` }}></div>))}</div>
                                                                            {dragState.type === 'create' && dragState.subitemId === sub.id && (<div className="absolute top-1/2 -translate-y-1/2 h-2/3 rounded-md shadow-sm border-2 border-dashed border-blue-400 bg-blue-400/20 z-10 pointer-events-none" style={{ left: `${dayToVisualIndex[dragState.originalStart] * zoomLevel}px`, width: `${dragState.currentSpan * zoomLevel}px` }} />)}
                                                                            {dragState.isDeleteMode && dragState.subitemId === sub.id && dragState.origin === 'expanded' && (<div className="absolute top-1/2 -translate-y-1/2 h-2/3 flex items-center justify-center z-50 pointer-events-none" style={{ left: `${dragState.currentVisualSlot * zoomLevel}px`, width: `${zoomLevel}px` }}><div className="bg-red-500 text-white p-1 rounded shadow-lg scale-75 animate-pulse"><Trash2 size={12} /></div></div>)}
                                                                            {sub.start !== null && !isSubDeleting && (<div className={`absolute top-1/2 -translate-y-1/2 h-3/4 rounded-md shadow-sm z-10 border overflow-hidden flex items-center ${darkMode ? 'border-[#181b34]' : 'border-white'}`} style={{ left: `${dayToVisualIndex[sub.start] * zoomLevel}px`, width: `${(dayToVisualIndex[sub.start + sub.duration] - dayToVisualIndex[sub.start]) * zoomLevel}px`, backgroundColor: getTaskColor(sub) }} onMouseDown={(e) => handleMouseDown(e, task, project.id, 'move', sub.id, 'expanded')}>
                                                                                 {zoomLevel > 15 && showLabels && <span className="truncate select-none pointer-events-none font-medium text-[9px] text-white pl-2 pr-1 block w-full text-left">{sub.name}</span>}
                                                                                 <div className="absolute left-0 top-0 bottom-0 w-2 cursor-ew-resize hover:bg-black/20 rounded-l-sm z-30" onMouseDown={(e) => handleMouseDown(e, task, project.id, 'resize-left', sub.id, 'expanded')}></div>
                                                                                 <div className="absolute right-0 top-0 bottom-0 w-2 cursor-ew-resize hover:bg-black/20 rounded-r-sm z-30" onMouseDown={(e) => handleMouseDown(e, task, project.id, 'resize-right', sub.id, 'expanded')}></div>
                                                                            </div>)}
                                                                    </div>
                                                            </div>
                                                         );
                                                    })}
                                                </React.Fragment>
                                            );
                                        })}
                                        {!isGroupCollapsed && (<div className={`flex border-b relative ${darkMode ? 'border-[#343856]' : 'border-[#eceff8]'}`} style={{ height: `${rowHeight}px` }}> <div className={`w-80 border-r flex-shrink-0 sticky left-0 z-30 flex items-center px-4 ${darkMode ? 'border-[#343856] bg-[#181b34]' : 'border-[#bec3d4] bg-white'}`}><div className="w-10 flex justify-center mr-2 opacity-50"><Plus size={14}/></div><input type="text" placeholder="+ Add Item" className={`bg-transparent outline-none text-sm w-full ${darkMode ? 'text-gray-400 placeholder-gray-600' : 'text-gray-500 placeholder-gray-400'}`} onKeyDown={(e) => { if (e.key === 'Enter' && e.target.value.trim()) { addTaskToGroup(project.id, group.id, e.target.value); e.target.value = ''; }}} /></div><div className="relative flex-1 h-full"><div className="absolute inset-0 flex pointer-events-none z-0">{visibleDays.map((day, i) => (<div key={i} className={`h-full border-r ${darkMode ? 'border-white/5' : 'border-[#eceff8]'} ${day.isWeekend ? 'bg-black/20' : 'bg-transparent'} ${!showWeekends && i > 0 && day.index > visibleDays[i-1].index + 1 ? (darkMode ? 'border-l-2 border-l-[#3d4058]' : 'border-l-2 border-l-gray-300') : ''} ${day.isToday ? 'bg-blue-500/10' : ''}`} style={{ width: `${zoomLevel}px`, minWidth: `${zoomLevel}px` }}></div>))}</div></div></div>)}
                                    </div>
                                 );
                            })}
                        </div>
                     );
                })}
             </div>
        </div>
    );
};

// ==========================================
// 6. MAIN CONTROLLER (BRAIN)
// ==========================================

export default function ProjectManagerAI() {
  const [activeTab, setActiveTab] = useState('board'); 
  const [darkMode, setDarkMode] = useState(true); 
  const [showWeekends, setShowWeekends] = useState(false); 
  const [showLabels, setShowLabels] = useState(true);
  const [colorBy, setColorBy] = useState('status'); 
  const [settingsMenuOpen, setSettingsMenuOpen] = useState(false);
  const [workspaces, setWorkspaces] = usePersistentState('pmai_workspaces', INITIAL_WORKSPACES);
  const [dashboards, setDashboards] = usePersistentState('pmai_dashboards', INITIAL_DASHBOARDS);
  const [activeEntityId, setActiveEntityId] = useState(INITIAL_WORKSPACES[0].id); 
  const [statuses, setStatuses] = usePersistentState('pmai_statuses', DEFAULT_STATUSES);
  const [jobTypes, setJobTypes] = usePersistentState('pmai_jobTypes', DEFAULT_JOB_TYPES);
  const [isChatOpen, setIsChatOpen] = useState(true);
  const [chatHistory, setChatHistory] = useState([{ role: 'ai', text: "Workspace ready." }]);
  const [inputText, setInputText] = useState('');
  const [zoomLevel, setZoomLevel] = useState(30); 
  const [rowHeight, setRowHeight] = useState(40); 
  const [statusMenuOpen, setStatusMenuOpen] = useState(null); 
  const [statusMenuType, setStatusMenuType] = useState('status'); 
  const [statusEditorOpen, setStatusEditorOpen] = useState(false); 
  const [jobTypeEditorOpen, setJobTypeEditorOpen] = useState(false); 
  const [datePickerOpen, setDatePickerOpen] = useState(null);
  const [selectedItems, setSelectedItems] = useState(new Set());
  const [collapsedGroups, setCollapsedGroups] = useState([]);
  const [expandedItems, setExpandedItems] = useState(['t1']); 
  const [reorderDrag, setReorderDrag] = useState({ active: false, type: null, dragId: null, parentId: null, dropTargetId: null, dropPosition: 'before', originalExpanded: false });
  const [dragState, setDragState] = useState({ isDragging: false, type: null, taskId: null, subitemId: null, projectId: null, startX: 0, originalStart: 0, originalDuration: 0, currentSpan: 0, currentVisualSlot: 0, hasMoved: false, isDeleteMode: false, origin: null });
  const bodyRef = useRef(null);
  const dragTimeoutRef = useRef(null); 

  // --- DERIVED STATE ---
  const rawDays = useMemo(() => generateTimelineData(), []);
  const { visibleDays, visibleMonths, dayToVisualIndex, visualIndexToDayIndex } = useMemo(() => {
    const days = []; const d2v = {}; const v2d = {}; let visualIndex = 0;
    
    // Check if today is a weekend and we are hiding weekends
    let weekendTodayHidden = false;
    if (!showWeekends) {
        const todayDay = rawDays.find(d => d.index === 0); // index 0 is TODAY
        if (todayDay && (todayDay.isWeekend)) {
            weekendTodayHidden = true;
        }
    }

    rawDays.forEach((day) => {
        let isEndOfWeekToday = false;
        
        if (!showWeekends) {
             // If today is hidden (weekend), mark the preceding Friday
             if (weekendTodayHidden && day.dayName === 'Fri') {
                 // Check if this Friday is immediately before "today"
                 const todayIndex = rawDays.findIndex(d => d.index === 0);
                 const thisIndex = rawDays.indexOf(day);
                 if (todayIndex > thisIndex && (todayIndex - thisIndex) <= 2) {
                     isEndOfWeekToday = true;
                 }
             }
        }

        if (showWeekends || !day.isWeekend) { 
            days.push({ ...day, visualIndex, isEndOfWeekToday }); 
            d2v[day.index] = visualIndex; 
            v2d[visualIndex] = day.index; 
            visualIndex++; 
        } else { 
            // Map hidden weekend days to the NEXT visible day index (Monday start)
            // This ensures duration math (End - Start) works for tasks ending on Friday.
            d2v[day.index] = visualIndex; 
        }
    });

    const months = []; let currentMonthLabel = ''; let currentMonthCount = 0;
    days.forEach(day => { if (day.monthName !== currentMonthLabel) { if (currentMonthLabel) months.push({ name: currentMonthLabel, count: currentMonthCount }); currentMonthLabel = day.monthName; currentMonthCount = 1; } else { currentMonthCount++; } });
    if (currentMonthLabel) months.push({ name: currentMonthLabel, count: currentMonthCount });
    return { visibleDays: days, visibleMonths: months, dayToVisualIndex: d2v, visualIndexToDayIndex: v2d };
  }, [rawDays, showWeekends]);

  // Use the new hook!
  const { 
    projects, setProjects, 
    addGroup, updateProjectName, updateGroupName, updateTaskName, updateSubitemName, 
    addTaskToGroup, addSubitem, updateTaskDate, changeStatus, changeJobType, deleteSelection
  } = useProjectData();

  const activeEntity = [...workspaces, ...dashboards].find(e => e.id === activeEntityId) || workspaces[0];
  const visibleProjects = useMemo(() => {
    if (activeEntity.type === 'workspace') return projects.filter(p => p.workspaceId === activeEntity.id);
    return projects.filter(p => activeEntity.includedWorkspaces.includes(p.workspaceId));
  }, [projects, activeEntity]);

  // --- LOCAL ACTIONS ---
  const createWorkspace = () => { const newId = `w${Date.now()}`; setWorkspaces(prev => [...prev, { id: newId, name: 'New Workspace', type: 'workspace' }]); setActiveEntityId(newId); };
  const createDashboard = () => { const newId = `d${Date.now()}`; setDashboards(prev => [...prev, { id: newId, name: 'New Dashboard', type: 'dashboard', includedWorkspaces: [] }]); setActiveEntityId(newId); };
  
  const toggleSelection = (id) => { const newSet = new Set(selectedItems); if (newSet.has(id)) newSet.delete(id); else newSet.add(id); setSelectedItems(newSet); };
  const deleteSelected = () => { deleteSelection(selectedItems); setSelectedItems(new Set()); };
  const toggleGroupCollapse = (gid) => setCollapsedGroups(prev => prev.includes(gid) ? prev.filter(id => id !== gid) : [...prev, gid]);
  const toggleItemExpand = (tid) => setExpandedItems(prev => prev.includes(tid) ? prev.filter(id => id !== tid) : [...prev, tid]);

  const scrollToToday = (smooth = true) => { 
    if (bodyRef.current && dayToVisualIndex[0] !== undefined) { 
        const container = bodyRef.current;
        const containerWidth = container.clientWidth;
        const sidebarWidth = 320;
        
        // Adjust focus if today is hidden weekend
        let targetVisualIdx = dayToVisualIndex[0];
        const todayDay = rawDays.find(d => d.index === 0);
        if (!showWeekends && todayDay && todayDay.isWeekend) {
             targetVisualIdx = Math.max(0, targetVisualIdx - 1);
        }

        const todayX = targetVisualIdx * zoomLevel;
        const centerOffset = (containerWidth - sidebarWidth) / 2;
        const scrollLeft = todayX - centerOffset + (zoomLevel / 2);
        
        container.scrollTo({ left: Math.max(0, scrollLeft), behavior: smooth ? 'smooth' : 'auto' }); 
    } 
  };

  // AUTO-SCROLL ON GANTT LOAD & ZOOM
  useLayoutEffect(() => {
      if (activeTab === 'gantt') {
          scrollToToday(false);
      }
  }, [activeTab, zoomLevel]); // Added zoomLevel here

  // --- DRAG HANDLERS (ROWS) ---
  const handleRowDragStart = (e, type, id, index, parentId, groupId) => { 
    e.stopPropagation(); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', id);
    const wasExpanded = expandedItems.includes(id);
    if (type === 'task' && wasExpanded) setExpandedItems(prev => prev.filter(tid => tid !== id));
    dragTimeoutRef.current = setTimeout(() => { setReorderDrag({ active: true, type, dragId: id, parentId, dropTargetId: null, dropPosition: 'before', originalExpanded: wasExpanded }); }, 10);
  };
  const handleRowDragOver = (e, type, id) => { 
    e.preventDefault(); e.stopPropagation(); 
    if(!reorderDrag.active || reorderDrag.type !== type) return;
    const rect = e.currentTarget.getBoundingClientRect(); const midY = rect.top + rect.height / 2; const position = e.clientY >= midY ? 'after' : 'before';
    if(reorderDrag.dropTargetId !== id || reorderDrag.dropPosition !== position) setReorderDrag(prev => ({ ...prev, dropTargetId: id, dropPosition: position })); 
  };
  const handleRowDrop = (e) => {
    e.preventDefault();
    if (!reorderDrag.active || !reorderDrag.dropTargetId || reorderDrag.dragId === reorderDrag.dropTargetId) { handleRowDragEnd(); return; }
    setProjects(prev => {
        const newProjects = JSON.parse(JSON.stringify(prev));
        const findLocation = (itemId, itemType) => { for(let pIdx=0; pIdx<newProjects.length; pIdx++) { for(let tIdx=0; tIdx<newProjects[pIdx].tasks.length; tIdx++) { const task = newProjects[pIdx].tasks[tIdx]; if (itemType === 'task' && task.id === itemId) return { pIdx, tIdx }; if (itemType === 'subitem') { const sIdx = task.subitems.findIndex(s => s.id === itemId); if (sIdx !== -1) return { pIdx, tIdx, sIdx }; } } } return null; };
        const source = findLocation(reorderDrag.dragId, reorderDrag.type); const target = findLocation(reorderDrag.dropTargetId, reorderDrag.type);
        if (source && target) {
             if (reorderDrag.type === 'task') {
                 const [moved] = newProjects[source.pIdx].tasks.splice(source.tIdx, 1);
                 let idx = target.tIdx; if (reorderDrag.dropPosition === 'after') idx++;
                 if (source.pIdx === target.pIdx && source.tIdx < target.tIdx) idx--;
                 newProjects[target.pIdx].tasks.splice(idx, 0, moved);
                 const tTask = newProjects[target.pIdx].tasks[target.tIdx]; if (tTask) moved.groupId = tTask.groupId;
             } else if (reorderDrag.type === 'subitem') {
                 const [moved] = newProjects[source.pIdx].tasks[source.tIdx].subitems.splice(source.sIdx, 1);
                 let idx = target.sIdx; if (reorderDrag.dropPosition === 'after') idx++;
                 if (source.pIdx === target.pIdx && source.tIdx === target.tIdx && source.sIdx < target.sIdx) idx--;
                 newProjects[target.pIdx].tasks[target.tIdx].subitems.splice(idx, 0, moved);
             }
        }
        return newProjects;
    });
    handleRowDragEnd();
  };
  const handleRowDragEnd = () => { if (dragTimeoutRef.current) clearTimeout(dragTimeoutRef.current); if (reorderDrag.active && reorderDrag.originalExpanded && reorderDrag.dragId) setExpandedItems(prev => [...prev, reorderDrag.dragId]); setReorderDrag({ active: false, type: null, dragId: null, parentId: null, originalExpanded: false }); };

  // --- DRAG HANDLERS (GANTT BARS) ---
  const handleMouseDown = (e, task, projectId, type, subitemId = null, origin = 'parent') => {
    e.stopPropagation(); if (e.target.tagName === 'INPUT') return; 
    let startDayIndex = 0;
    if (type === 'create') {
        if (subitemId ? task.subitems?.find(s => s.id === subitemId)?.start : task.start) return; 
        const clickX = e.nativeEvent.offsetX; const visualIndex = Math.floor(clickX / zoomLevel); startDayIndex = visualIndexToDayIndex[visualIndex] || 0;
    }
    setDragState({ isDragging: true, type, taskId: task.id, subitemId, projectId, startX: e.clientX, originalStart: type === 'create' ? startDayIndex : (subitemId ? task.subitems.find(s=>s.id===subitemId).start : task.start), originalDuration: type === 'create' ? 1 : (subitemId ? task.subitems.find(s=>s.id===subitemId).duration : task.duration), currentSpan: 1, hasMoved: false, isDeleteMode: false, origin, currentVisualSlot: 0 });
  };

  useEffect(() => {
    const handleMouseMove = (e) => {
      if (!dragState.isDragging) return;
      const deltaX = e.clientX - dragState.startX;
      if (Math.abs(deltaX) > 5) setDragState(prev => ({ ...prev, hasMoved: true }));
      const deltaVisualSlots = Math.round(deltaX / zoomLevel);

      if (dragState.type === 'create') { setDragState(prev => ({ ...prev, currentSpan: Math.max(1, 1 + deltaVisualSlots) })); return; }

      const origVisStart = dayToVisualIndex[dragState.originalStart];
      const origVisEnd = dayToVisualIndex[dragState.originalStart + dragState.originalDuration];
      let deleteMode = false; let fixedBin = 0;

      if (dragState.type === 'resize-right') { if (origVisEnd + deltaVisualSlots <= origVisStart) { deleteMode = true; fixedBin = origVisStart - 1; } } 
      else if (dragState.type === 'resize-left') { if (origVisStart + deltaVisualSlots >= origVisEnd) { deleteMode = true; fixedBin = origVisEnd; } }

      if (deleteMode) { setDragState(prev => ({ ...prev, isDeleteMode: true, currentVisualSlot: fixedBin })); return; }
      else if (dragState.isDeleteMode) setDragState(prev => ({ ...prev, isDeleteMode: false }));

      setProjects(prev => prev.map(proj => {
        if (proj.id !== dragState.projectId) return proj;
        return { ...proj, tasks: proj.tasks.map(task => {
             if (dragState.subitemId) {
                 if (task.id === dragState.taskId) { 
                     return { ...task, subitems: task.subitems.map(sub => {
                         if (sub.id !== dragState.subitemId) return sub;
                         if (dragState.type === 'move') {
                             const newStart = visualIndexToDayIndex[Math.max(0, origVisStart + deltaVisualSlots)];
                             if (newStart !== undefined) return { ...sub, start: newStart, duration: calculateCalendarDuration(newStart, origVisEnd - origVisStart, rawDays, showWeekends) };
                         } else if (dragState.type === 'resize-right') {
                             const newVisEnd = Math.max(origVisStart + 1, origVisEnd + deltaVisualSlots);
                             return { ...sub, duration: calculateCalendarDuration(dragState.originalStart, newVisEnd - origVisStart, rawDays, showWeekends) };
                         } else if (dragState.type === 'resize-left') {
                             const newVisStart = Math.min(Math.max(0, origVisStart + deltaVisualSlots), origVisEnd - 1);
                             const newStart = visualIndexToDayIndex[newVisStart];
                             const endDay = dragState.originalStart + dragState.originalDuration;
                             return { ...sub, start: newStart, duration: Math.max(1, endDay - newStart) };
                         }
                         return sub;
                     })};
                 }
                 return task;
             }
             if (task.id !== dragState.taskId) return task;
             if (dragState.type === 'move') {
                 const newStart = visualIndexToDayIndex[Math.max(0, origVisStart + deltaVisualSlots)];
                 if (newStart !== undefined) return { ...task, start: newStart, duration: calculateCalendarDuration(newStart, origVisEnd - origVisStart, rawDays, showWeekends) };
             } else if (dragState.type === 'resize-right') {
                 const newVisEnd = Math.max(origVisStart + 1, origVisEnd + deltaVisualSlots);
                 return { ...task, duration: calculateCalendarDuration(dragState.originalStart, newVisEnd - origVisStart, rawDays, showWeekends) };
             } else if (dragState.type === 'resize-left') {
                 const newVisStart = Math.min(Math.max(0, origVisStart + deltaVisualSlots), origVisEnd - 1);
                 const newStart = visualIndexToDayIndex[newVisStart];
                 const endDay = dragState.originalStart + dragState.originalDuration;
                 return { ...task, start: newStart, duration: Math.max(1, endDay - newStart) };
             }
             return task;
          })
        };
      }));
    };
    const handleMouseUp = () => {
      if (dragState.isDragging) {
        if (dragState.isDeleteMode) { updateTaskDate(dragState.projectId, dragState.taskId, dragState.subitemId, null, null); }
        else if (dragState.type === 'create') { updateTaskDate(dragState.projectId, dragState.taskId, dragState.subitemId, dragState.originalStart, calculateCalendarDuration(dragState.originalStart, dragState.currentSpan, rawDays, showWeekends)); }
        setDragState(prev => ({ ...prev, isDragging: false, type: null, isDeleteMode: false }));
      }
    };
    if (dragState.isDragging) { window.addEventListener('mousemove', handleMouseMove); window.addEventListener('mouseup', handleMouseUp); }
    return () => { window.removeEventListener('mousemove', handleMouseMove); window.removeEventListener('mouseup', handleMouseUp); };
  }, [dragState, zoomLevel, dayToVisualIndex, visualIndexToDayIndex, showWeekends, rawDays]);

  const exportData = () => {
    const headers = ["Project", "Group", "Task Name", "Type", "Status", "Job Type", "Assignee", "Start Date", "Duration (Days)"];
    const csvRows = [headers.join(",")];

    projects.forEach(project => {
      const groups = project.groups || [];
      groups.forEach(group => {
        const tasks = project.tasks.filter(t => t.groupId === group.id || (!t.groupId && group.id === 'default'));
        tasks.forEach(task => {
          // Resolve labels
          const statusLabel = statuses.find(s => s.id === task.status)?.label || task.status;
          const jobTypeLabel = jobTypes.find(j => j.id === task.jobTypeId)?.label || task.jobTypeId;
          const startDate = task.start !== null ? getFutureDate(task.start) : "TBD";
          
          // Escape quotes for CSV safety
          const clean = (str) => `"${String(str || '').replace(/"/g, '""')}"`;

          csvRows.push([
            clean(project.name),
            clean(group.name),
            clean(task.name),
            "Task",
            clean(statusLabel),
            clean(jobTypeLabel),
            clean(task.assignee),
            clean(startDate),
            task.duration || 0
          ].join(","));

          // Subitems
          if (task.subitems && task.subitems.length > 0) {
            task.subitems.forEach(sub => {
               const subStatus = statuses.find(s => s.id === sub.status)?.label || sub.status;
               const subJob = jobTypes.find(j => j.id === sub.jobTypeId)?.label || sub.jobTypeId;
               const subStart = sub.start !== null ? getFutureDate(sub.start) : "TBD";
               
               csvRows.push([
                clean(project.name),
                clean(group.name),
                clean(`   ${sub.name}`), // Visual indentation
                "Subitem",
                clean(subStatus),
                clean(subJob),
                clean(sub.assignee),
                clean(subStart),
                sub.duration || 0
              ].join(","));
            });
          }
        });
      });
    });

    const csvString = csvRows.join("\n");
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `project_export_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
  };

  const exportJson = () => {
    const data = {
      projects,
      workspaces,
      dashboards,
      statuses,
      jobTypes
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `project_manager_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
  };

  const importJson = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        if (data.projects) setProjects(data.projects);
        if (data.workspaces) setWorkspaces(data.workspaces);
        if (data.dashboards) setDashboards(data.dashboards);
        if (data.statuses) setStatuses(data.statuses);
        if (data.jobTypes) setJobTypes(data.jobTypes);
        alert('Data loaded successfully!');
      } catch (err) {
        console.error("Failed to parse JSON", err);
        alert('Invalid JSON file');
      }
    };
    reader.readAsText(file);
  };

  return (
    <div className={`flex h-screen font-sans overflow-hidden select-none transition-colors duration-300 ${darkMode ? 'bg-[#181b34] text-gray-100' : 'bg-[#eceff8] text-[#323338]'}`} onClick={() => { setStatusMenuOpen(null); setSettingsMenuOpen(false); setDatePickerOpen(null); }}>
        <Sidebar darkMode={darkMode} workspaces={workspaces} dashboards={dashboards} activeEntityId={activeEntityId} setActiveEntityId={setActiveEntityId} createWorkspace={createWorkspace} createDashboard={createDashboard} setDarkMode={setDarkMode} />
        
        <div className={`flex-1 flex flex-col min-w-0 relative ${darkMode ? 'bg-[#181b34]' : 'bg-white'}`}>
            <AppHeader 
                activeEntity={activeEntity} activeTab={activeTab} setActiveTab={setActiveTab} darkMode={darkMode}
                setSettingsMenuOpen={setSettingsMenuOpen} settingsMenuOpen={settingsMenuOpen}
                showWeekends={showWeekends} setShowWeekends={setShowWeekends} showLabels={showLabels} setShowLabels={setShowLabels}
                colorBy={colorBy} setColorBy={setColorBy} zoomLevel={zoomLevel} handleZoomChange={(e) => setZoomLevel(Number(e.target.value))}
                rowHeight={rowHeight} setRowHeight={setRowHeight} isChatOpen={isChatOpen} setIsChatOpen={setIsChatOpen}
                scrollToToday={scrollToToday} updateEntityName={(v) => { if(activeEntity.type==='workspace') setWorkspaces(p=>p.map(w=>w.id===activeEntity.id?{...w,name:v}:w)); else setDashboards(p=>p.map(d=>d.id===activeEntity.id?{...d,name:v}:d)); }}
                onExport={exportData} onExportJson={exportJson} onImportJson={importJson}
            />

            <div className={`flex-1 overflow-hidden flex flex-col relative ${darkMode ? 'bg-[#181b34]' : 'bg-white'}`}>
                {activeTab === 'board' ? (
                    <BoardView 
                        activeTab={activeTab} 
                        visibleProjects={visibleProjects} collapsedGroups={collapsedGroups} toggleGroupCollapse={toggleGroupCollapse}
                        updateGroupName={updateGroupName} statuses={statuses} jobTypes={jobTypes} darkMode={darkMode}
                        addTaskToGroup={addTaskToGroup} addGroup={addGroup} expandedItems={expandedItems} toggleItemExpand={toggleItemExpand}
                        updateTaskName={updateTaskName} updateSubitemName={updateSubitemName} handleAddSubitem={addSubitem}
                        handleRowDragStart={handleRowDragStart} handleRowDragOver={handleRowDragOver} handleRowDrop={handleRowDrop} handleRowDragEnd={handleRowDragEnd}
                        reorderDrag={reorderDrag} selectedItems={selectedItems} toggleSelection={toggleSelection}
                        setStatusMenuOpen={setStatusMenuOpen} setStatusMenuType={setStatusMenuType} setDatePickerOpen={setDatePickerOpen}
                        statusMenuOpen={statusMenuOpen} statusMenuType={statusMenuType} 
                        onStatusSelect={changeStatus} onTypeSelect={changeJobType} onEditLabels={() => setStatusEditorOpen(true)}
                    />
                ) : (
                    <GanttView 
                        visibleProjects={visibleProjects} collapsedGroups={collapsedGroups} toggleGroupCollapse={toggleGroupCollapse}
                        darkMode={darkMode} rowHeight={rowHeight} visibleDays={visibleDays} visibleMonths={visibleMonths}
                        zoomLevel={zoomLevel} dayToVisualIndex={dayToVisualIndex} visualIndexToDayIndex={visualIndexToDayIndex}
                        showWeekends={showWeekends} showLabels={showLabels} statuses={statuses} jobTypes={jobTypes} colorBy={colorBy}
                        dragState={dragState} handleMouseDown={handleMouseDown}
                        handleRowDragStart={handleRowDragStart} handleRowDragOver={handleRowDragOver} handleRowDrop={handleRowDrop} handleRowDragEnd={handleRowDragEnd}
                        reorderDrag={reorderDrag} selectedItems={selectedItems} toggleSelection={toggleSelection}
                        handleAddSubitem={addSubitem} updateTaskName={updateTaskName} addTaskToGroup={addTaskToGroup}
                        expandedItems={expandedItems} toggleItemExpand={toggleItemExpand} updateSubitemName={updateSubitemName}
                        setStatusMenuOpen={setStatusMenuOpen} setStatusMenuType={setStatusMenuType} setDatePickerOpen={setDatePickerOpen}
                        onStatusSelect={changeStatus} onTypeSelect={changeJobType} onEditLabels={() => setStatusEditorOpen(true)}
                        bodyRef={bodyRef}
                    />
                )}
            </div>

            <div className={`fixed bottom-6 left-1/2 -translate-x-1/2 z-[200] shadow-2xl border rounded-xl px-4 py-2 flex items-center gap-3 transition-all duration-300 ease-in-out ${selectedItems.size > 0 ? 'translate-y-0 opacity-100' : 'translate-y-24 opacity-0 pointer-events-none'} ${darkMode ? 'bg-[#111322] border-[#343856]' : 'bg-white border-gray-300'}`}>
                <span className={`text-xs font-medium ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>{selectedItems.size} selected</span>
                <button onClick={deleteSelected} className="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-colors shadow-sm"><Trash2 size={14} /> Delete</button>
            </div>
            
            <DatePicker datePickerOpen={datePickerOpen} setDatePickerOpen={setDatePickerOpen} darkMode={darkMode} updateTaskDate={updateTaskDate} />
            <LabelEditorModal isOpen={statusEditorOpen} onClose={() => setStatusEditorOpen(false)} items={statuses} onSave={setStatuses} title="Edit Status Labels" darkMode={darkMode} />
            <LabelEditorModal isOpen={jobTypeEditorOpen} onClose={() => setJobTypeEditorOpen(false)} items={jobTypes} onSave={setJobTypes} title="Edit Type Labels" darkMode={darkMode} />
        </div>
    </div>
  );
}